{% extends "base/base.html" %}
{% load static %}

{% block title %}Forgot Password{% endblock %}

{% block start %}
<section class="section-content padding-bottom">
  <div class="container-xl d-flex justify-content-center align-items-center mt-5">
    <div class="row justify-content-center w-100">
      <div class="col-xl-4">

        <div class="card mb-4">
          <div class="card-header text-center" style="font-size: 25px;">
            {% if token %}
              Reset Password
            {% else %}
              Forgot Password
            {% endif %}
          </div>

          <div class="card-body">

            {% csrf_token %}

            {% if not token %}
            <!-- Email form -->
            <form id="forgotForm">
              <div class="form-group">
                <input class="form-control" type="email" id="email" placeholder="Enter your email" required />
              </div>
              <button class="btn btn-primary btn-block">Send Reset Link</button>
              <p class="text-center mt-3">
                <a href="{% url 'login' %}">Back to Login</a>
              </p>
            </form>
            {% endif %}

            {% if token %}
            <!-- Reset password form -->
            <form id="resetForm">
              <div class="form-group">
                <input class="form-control" type="password" id="password" placeholder="New Password" required />
              </div>
              <div class="form-group">
                <input class="form-control" type="password" id="confirm_password" placeholder="Confirm Password" required />
              </div>

              <input type="hidden" id="reset_token" value="{{ token }}">

              <button class="btn btn-success btn-block">Reset Password</button>
            </form>
            {% endif %}

          </div>
        </div>

      </div>
    </div>
  </div>
</section>
{% endblock %}


<!-- ========== JAVASCRIPT SECTION ========== -->


{% if not token %}
<script>
// ----- SEND RESET EMAIL -----
document.getElementById("forgotForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const email = document.getElementById("email").value;

    const response = await fetch("/api/accounts/forgot-password/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email }),
    });

    const data = await response.json();

    if (response.ok) {
        toastr.success("Reset link sent! Check your email.");
    } else {
        toastr.error(data.detail || "Error sending reset email.");
    }
});
</script>
{% endif %}



{% if token %}
<script>
// ----- RESET PASSWORD -----
document.getElementById("resetForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const password = document.getElementById("password").value;
    const confirm = document.getElementById("confirm_password").value;
    const token = document.getElementById("reset_token").value;

    if (password !== confirm) {
        toastr.error("Passwords do not match.");
        return;
    }

    const response = await fetch(`/api/accounts/reset-password/${token}/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password }),
    });

    const data = await response.json();

    if (response.ok) {
        toastr.success("Password updated! Redirecting...");
        setTimeout(() => (window.location.href = "/accounts/login/"), 2000);
    } else {
        toastr.error(data.detail || "Failed to reset password.");
    }
});
</script>
{% endif %}
